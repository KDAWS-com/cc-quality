---
description: >
  AI-powered security scanning with platform auto-detection and intelligent triage.
  Runs semgrep, phpstan, composer audit, govulncheck, gosec based on detected platform.
  Posts findings to PR with blocking/dismissed/warning classification.
  Command: quality:security-review.
  Trigger: "security review", "scan for vulnerabilities", "check security".
argument-hint: ""
allowed-tools: Bash(semgrep scan *), Bash(phpstan analyse *), Bash(composer audit *), Bash(govulncheck *), Bash(gosec *), Bash(gitleaks detect *), Bash(gitleaks protect *), Bash(git merge-base *), Bash(git diff *), Bash(git log *), Bash(git status), Bash(gh pr comment *), Bash(gh api repos/*/pulls/*/comments *), Read, Write, Edit
---

# Security Review: `quality:security-review`

Run a security scan with AI-powered triage. Can be invoked standalone or as part of a pipeline. Operates on the current branch/PR.

## Platform Detection

Auto-detect platform from project files on each run:

| Signal | Platform |
|--------|----------|
| `artisan` + `composer.json` with `laravel/framework` | Laravel |
| `wp-config.php` or `composer.json` with WordPress deps | WordPress |
| `go.mod` | Go |
| `composer.json` (no Laravel/WP signals) | PHP |
| No signals detected | Fallback ‚Äî run semgrep with `p/ci` only, warn that platform-specific rules are not configured |

Multi-platform: detect ALL platforms present, run tools for each. Confirm with user on first detection.

## Tool Availability & Installation

Check required tools per platform. If missing, ask permission to install:

| Tool | Install | Platforms |
|------|---------|-----------|
| `semgrep` | `pip install semgrep` | All |
| `phpstan` | `composer require --dev phpstan/phpstan` | PHP, Laravel, WP |
| `larastan` | `composer require --dev larastan/larastan` | Laravel |
| `phpstan-wordpress` | `composer require --dev szepeviktor/phpstan-wordpress` | WordPress |
| `gosec` | `go install github.com/securego/gosec/v2/cmd/gosec@latest` | Go |
| `govulncheck` | `go install golang.org/x/vuln/cmd/govulncheck@latest` | Go |

> **Note:** `gitleaks` is a pre-commit tool installed by `wflow:setup`, not a runtime dependency of `quality:security-review`.

## Scan Steps

1. **Run scans** (parallel where possible, semgrep scoped to PR diff via `--baseline-commit`; other tools scan full codebase):

   PHP/Laravel/WordPress:
   ```bash
   semgrep scan --disable-nosem --baseline-commit $(git merge-base HEAD main) --config p/ci --config p/php [--config p/laravel] [--config p/phpcs-security-audit] --json
   phpstan analyse --level 8 --no-progress --error-format=json
   composer audit --format=json
   ```

   Go:
   ```bash
   semgrep scan --disable-nosem --baseline-commit $(git merge-base HEAD main) --config p/ci --config p/golang --json
   govulncheck ./...
   gosec -fmt=json ./...
   ```

2. **AI triage** ‚Äî For each finding, Claude evaluates with full code context:
   - Real vulnerability ‚Üí **block** (add to findings list)
   - Noise/false positive ‚Üí **dismiss** (add justified `// nosemgrep: {rule-id} ‚Äî {reason}` comment as a deliberate commit)
   - Dependency CVE ‚Üí assess if vulnerable code path is actually used. Exploitable ‚Üí block. Theoretical ‚Üí warn.

3. **Post results to PR** ‚Äî New collapsible comment each scan cycle (preserves audit trail):

   ```markdown
   <!-- workflow-stage: security-review, date: {YYYY-MM-DD}, command: quality:security-review -->
   <details>
   <summary>üõ°Ô∏è Security Review ‚Äî {YYYY-MM-DD} ‚Äî {PASS|FAIL}</summary>

   **Platform:** {platforms} ¬∑ **Tools:** {tools run}
   **Findings:** {N blocking}, {N dismissed}, {N warnings}

   ### Blocking Findings
   | Tool | Rule | Location | Description | Fix |
   |------|------|----------|-------------|-----|
   | ... | ... | ... | ... | ... |

   **Dismissed:** {N} false positives (nosemgrep comments added with justification)
   **Dependencies:** {N} CVEs triaged ({N} exploitable, {N} theoretical)

   ---
   *Generated by `quality:security-review` ‚Ä¢ Cycle {N}/3*
   </details>
   ```

4. **Block or proceed:**
   - Blocking findings exist ‚Üí fix directly on the current branch, then re-run `quality:security-review`.
   - All clear ‚Üí signal ready to proceed.

## Output Contract

When invoked from another plugin (e.g., `wflow`), this skill:

- **Posts** a collapsible PR comment with `<!-- workflow-stage: security-review -->` marker
- **Summary line** contains `PASS` or `FAIL`
- **Does not track** cycle counts ‚Äî the calling orchestrator owns cycle management
